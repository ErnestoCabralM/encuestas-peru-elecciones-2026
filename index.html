<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Encuestas Per√∫ 2026</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body{font-family:sans-serif;padding:20px}
button{margin:4px;padding:6px 10px;border:1px solid #ccc;cursor:pointer;background:white}
button.active{color:white;border:none}
.button-group{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px}
h3{margin:18px 0 6px 0;font-weight:600}
</style>
</head>

<body>

<h2>Intenci√≥n de voto Per√∫ 2026</h2>

<h3>Elige un candidato</h3>
<button id="btn-todos-candidatos">Todos los candidatos</button>
<button id="btn-ninguno-candidatos">Deseleccionar todos</button>
<div id="candidatos-container" class="button-group"></div>

<h3>Elige una encuesta</h3>
<div id="encuestas-container" class="button-group"></div>

<canvas id="grafico" height="120"></canvas>

<script>
window.onload = function(){

const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR2lpNTnGdTb9RxRNujPEjF3ihNgw7IN-WPN-zG4-DJmXvYNyuc1GYPp2npeGKmnZIeNm50Fi3AZIHS/pub?gid=1021106762&single=true&output=csv";

let rawData = [];
let chart;
let encuestaActiva = null;
let candidatosSeleccionados = [];

const COLORES = [
"#4E79A7","#F28E2B","#E15759","#76B7B2","#59A14F",
"#EDC948","#B07AA1","#FF9DA7","#9C755F","#BAB0AC",
"#1F77B4","#FF7F0E","#2CA02C","#D62728","#9467BD",
"#8C564B","#E377C2","#7F7F7F","#BCBD22","#17BECF"
];

const mapaColorCandidato = {};

const MESES = {
  ene:1,feb:2,mar:3,abr:4,may:5,jun:6,
  jul:7,ago:8,sep:9,sept:9,oct:10,nov:11,dic:12
};

function ordenarFechas(a,b){
  const [ma,ya]=a.toLowerCase().split(" ");
  const [mb,yb]=b.toLowerCase().split(" ");
  return (ya-yb)||(MESES[ma]-MESES[mb]);
}

Papa.parse(CSV_URL + "&t=" + new Date().getTime(),{
  download:true,
  header:true,
  complete:function(res){
    rawData=res.data.map(r=>({
      fecha:r.fecha.trim(),
      encuesta:r.encuesta.trim(),
      candidato:r.candidato.trim(),
      tipo:r.Tipo?.trim()||'',
      valor:parseFloat(r.valor)
    }));
    iniciar();
  }
});

function pintarBoton(boton, candidato){
  const color = mapaColorCandidato[candidato];
  boton.style.backgroundColor = color;
  boton.style.color = "white";
}

function limpiarBoton(boton){
  boton.style.backgroundColor = "white";
  boton.style.color = "black";
}

function iniciar(){
  const candidatos=[...new Set(
    rawData.filter(d=>d.tipo==="Candidato oficial").map(d=>d.candidato)
  )].sort();

  candidatos.forEach((c,i)=>{
    mapaColorCandidato[c]=COLORES[i % COLORES.length];
  });

  const encuestas=[...new Set(rawData.map(d=>d.encuesta))].sort();

  const contC=document.getElementById("candidatos-container");
  candidatos.forEach(c=>{
    const b=document.createElement("button");
    b.textContent=c;

    b.onclick=()=>{
      b.classList.toggle("active");
      if(b.classList.contains("active")){
        pintarBoton(b,c);
      }else{
        limpiarBoton(b);
      }
      actualizar();
    }

    contC.appendChild(b);
  });

  document.getElementById("btn-todos-candidatos").onclick=()=>{
    document.querySelectorAll("#candidatos-container button")
      .forEach(b=>{
        b.classList.add("active");
        pintarBoton(b,b.textContent);
      });
    actualizar();
  };

  document.getElementById("btn-ninguno-candidatos").onclick=()=>{
    document.querySelectorAll("#candidatos-container button")
      .forEach(b=>{
        b.classList.remove("active");
        limpiarBoton(b);
      });
    actualizar();
  };

  const contE=document.getElementById("encuestas-container");
  encuestas.forEach((e,i)=>{
    const b=document.createElement("button");
    b.textContent=e;

    if(i===0){
      b.classList.add("active");
      encuestaActiva=e;
    }

    b.onclick=()=>{
      document.querySelectorAll("#encuestas-container button")
        .forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      encuestaActiva=e;
      actualizar();
    }

    contE.appendChild(b);
  });

  chart=new Chart(document.getElementById("grafico"),{
    type:"line",
    data:{labels:[],datasets:[]},
    options:{
      responsive:true,
      interaction:{mode:"nearest",intersect:true},
      plugins:{
        legend:{display:false},   /* üëà leyenda fuera */
        tooltip:{mode:"nearest",intersect:true}
      },
      scales:{y:{beginAtZero:true}}
    }
  });
}

function actualizar(){
  candidatosSeleccionados=Array.from(
    document.querySelectorAll("#candidatos-container .active")
  ).map(b=>b.textContent);

  if(!encuestaActiva || !candidatosSeleccionados.length) return;

  const filtrado=rawData.filter(d=>
    candidatosSeleccionados.includes(d.candidato)&&
    d.encuesta===encuestaActiva
  );

  const fechas=[...new Set(filtrado.map(d=>d.fecha))].sort(ordenarFechas);

  const datasets=candidatosSeleccionados.map(candidato=>{
    const color = mapaColorCandidato[candidato];

    return{
      label:`${candidato}`,
      data:fechas.map(f=>{
        const r=filtrado.find(x=>
          x.fecha===f &&
          x.candidato===candidato
        );
        return r? r.valor:null;
      }),
      borderColor: color,
      backgroundColor: color,
      borderWidth: 2,
      tension:0.3,
      spanGaps:true,
      pointRadius:4,
      pointHoverRadius:6
    }
  });

  chart.data.labels=fechas;
  chart.data.datasets=datasets;
  chart.update();
}

}
</script>

</body>
</html>
