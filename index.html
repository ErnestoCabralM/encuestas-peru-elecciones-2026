<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Encuestas Perú 2026</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body{font-family:sans-serif;padding:20px}
button{margin:4px;padding:6px 10px;border:1px solid #ccc;cursor:pointer}
button.active{background:black;color:white}
.button-group{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px}
</style>
</head>

<body>

<h2>Intención de voto Perú 2026</h2>

<div id="candidatos-container" class="button-group"></div>
<div id="encuestas-container" class="button-group"></div>

<canvas id="grafico" height="120"></canvas>

<script>
window.onload = function(){

const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR2lpNTnGdTb9RxRNujPEjF3ihNgw7IN-WPN-zG4-DJmXvYNyuc1GYPp2npeGKmnZIeNm50Fi3AZIHS/pub?gid=1021106762&single=true&output=csv";

let rawData = [];
let chart;
let encuestasActivas = [];
let candidatosSeleccionados = [];

const MESES = {ene:1,feb:2,mar:3,abr:4,may:5,jun:6,jul:7,ago:8,sep:9,oct:10,nov:11,dic:12};
function ordenarFechas(a,b){
  const [ma,ya]=a.split(" ");
  const [mb,yb]=b.split(" ");
  return (ya-yb)||(MESES[ma]-MESES[mb]);
}

Papa.parse(CSV_URL,{
  download:true,
  header:true,
  complete:function(res){
    rawData=res.data.map(r=>({
      fecha:r.fecha.trim(),
      encuesta:r.encuesta.trim(),
      candidato:r.candidato.trim(),
      tipo:r.Tipo?.trim()||'',
      valor:parseFloat(r.valor)
    }));
    iniciar();
  }
});

function iniciar(){
  const candidatos=[...new Set(
    rawData.filter(d=>d.tipo==="Candidato oficial").map(d=>d.candidato)
  )].sort();

  const encuestas=[...new Set(rawData.map(d=>d.encuesta))].sort();
  encuestasActivas=[...encuestas];

  const contC=document.getElementById("candidatos-container");
  candidatos.forEach(c=>{
    const b=document.createElement("button");
    b.textContent=c;
    b.onclick=()=>{b.classList.toggle("active");actualizar();}
    contC.appendChild(b);
  });

  const contE=document.getElementById("encuestas-container");
  encuestas.forEach(e=>{
    const b=document.createElement("button");
    b.textContent=e;
    b.classList.add("active");
    b.onclick=()=>{
      b.classList.toggle("active");
      encuestasActivas=Array.from(contE.querySelectorAll(".active")).map(x=>x.textContent);
      actualizar();
    }
    contE.appendChild(b);
  });

  chart=new Chart(document.getElementById("grafico"),{
    type:"line",
    data:{labels:[],datasets:[]},
    options:{
      responsive:true,
      interaction:{mode:"index",intersect:false},
      plugins:{legend:{position:"top"}},
      scales:{y:{beginAtZero:true}}
    }
  });
}

function actualizar(){
  candidatosSeleccionados=Array.from(
    document.querySelectorAll("#candidatos-container .active")
  ).map(b=>b.textContent);

  const filtrado=rawData.filter(d=>
    candidatosSeleccionados.includes(d.candidato)&&
    encuestasActivas.includes(d.encuesta)
  );

  const fechas=[...new Set(filtrado.map(d=>d.fecha))].sort(ordenarFechas);

  const combinaciones=[];
  filtrado.forEach(d=>{
    const key=d.candidato+"||"+d.encuesta;
    if(!combinaciones.includes(key)) combinaciones.push(key);
  });

  const datasets=combinaciones.map((key,i)=>{
    const [candidato,encuesta]=key.split("||");
    return{
      label:`${candidato} — ${encuesta}`,
      data:fechas.map(f=>{
        const r=filtrado.find(x=>
          x.fecha===f &&
          x.candidato===candidato &&
          x.encuesta===encuesta
        );
        return r? r.valor:null;
      }),
      tension:0.3,
      spanGaps:true
    }
  });

  chart.data.labels=fechas;
  chart.data.datasets=datasets;
  chart.update();
}

}
</script>

</body>
</html>
