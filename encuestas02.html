<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body{font-family:sans-serif;margin:20px}
button{margin:4px;padding:6px 10px;border:1px solid #ccc;cursor:pointer}
button.active{background:black;color:white}
select{padding:6px;margin-bottom:10px}
</style>
</head>
<body>

<h3>Intenci√≥n de voto</h3>

<select id="candidato"></select>
<div id="botones"></div>
<canvas id="grafico" height="120"></canvas>

<script>
const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR2lpNTnGdTb9RxRNujPEjF3ihNgw7IN-WPN-zG4-DJmXvYNyuc1GYPp2npeGKmnZIeNm50Fi3AZIHS/pub?gid=1021106762&single=true&output=csv";

let rawData = [];
let chart;
let encuestasActivas = [];

Papa.parse(url, {
  download: true,
  header: true,
  complete: function(res) {
    rawData = res.data.map(r => ({
      fecha: r.fecha,
      encuesta: r.encuesta,
      candidato: r.candidato,
      tipo: r.Tipo,
      valor: Number(r.valor)
    }));

    iniciar();
  }
});

function iniciar(){
  const candidatos = [...new Set(
    rawData.filter(d=>d.tipo==="Candidato oficial").map(d=>d.candidato)
  )].sort();

  const sel = document.getElementById("candidato");
  sel.innerHTML = "<option value=''>Selecciona candidato</option>";
  candidatos.forEach(c=>{
    sel.innerHTML += `<option value="${c}">${c}</option>`;
  });

  const encuestas = [...new Set(rawData.map(d=>d.encuesta))];
  encuestasActivas = [...encuestas];

  const cont = document.getElementById("botones");
  encuestas.forEach(e=>{
    const b=document.createElement("button");
    b.textContent=e;
    b.classList.add("active");
    b.onclick=()=>{
      b.classList.toggle("active");
      if(encuestasActivas.includes(e)){
        encuestasActivas=encuestasActivas.filter(x=>x!==e);
      }else{
        encuestasActivas.push(e);
      }
      actualizar();
    }
    cont.appendChild(b);
  });

  sel.onchange=actualizar;

  chart = new Chart(document.getElementById('grafico'), {
    type: 'line',
    data: { labels:[], datasets:[] },
    options: {
      responsive:true,
      interaction:{mode:'nearest',intersect:false},
      plugins:{legend:{position:'top'}}
    }
  });
}

function actualizar(){
  const candidato = document.getElementById("candidato").value;
  if(!candidato) return;

  const filtrado = rawData.filter(d =>
    d.candidato===candidato &&
    encuestasActivas.includes(d.encuesta)
  );

  const fechas = [...new Set(filtrado.map(d=>d.fecha))];

  const datasets = encuestasActivas.map(e=>{
    return {
      label:e,
      data: fechas.map(f=>{
        const r=filtrado.find(x=>x.fecha===f && x.encuesta===e);
        return r? r.valor : null;
      }),
      spanGaps:true
    }
  });

  chart.data.labels = fechas;
  chart.data.datasets = datasets;
  chart.update();
}
</script>

</body>
</html>
